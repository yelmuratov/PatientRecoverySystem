name: Deploy Backend to DigitalOcean

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Repo
      uses: actions/checkout@v3

    - name: ğŸ› ï¸ Install .NET SDK
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '9.0.x'  # Or match your backend version

    - name: ğŸ” Build .NET Backend
      run: |
        cd src/PatientRecoverySystem.API
        dotnet restore
        dotnet build --configuration Release

    # Optional: Run tests if you have them
    # - name: ğŸ§ª Run Tests
    #   run: dotnet test

    - name: ğŸš€ Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DO_HOST }}
        username: root
        key: ${{ secrets.DO_SSH_KEY }}
        script: |
          cd /root/assignments/PatientRecoverySystem/PatientRecoverySystem
          git pull origin main
          docker compose pull
          docker compose build api notificationservice
          docker compose up -d api notificationservice
